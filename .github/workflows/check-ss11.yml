name: ğŸ”” ç«ç‚¬ä¹‹å…‰ SS11 å…¬å‘Šç›‘æ§

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  check_announcement:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ•’ æ˜¾ç¤ºæ—¶é—´
        run: |
          echo "UTC: $(date -u)"
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: pip install requests

      - name: ğŸ“¡ æ£€æŸ¥å…¬å‘Šå¹¶æ¨é€å¾®ä¿¡
        env:
          SENDKEY: ${{ secrets.SENDKEY }}
        run: |
          python3 <<'EOF'
import requests
import os
import sys

JSON_URL = "https://website.xdcdn.net/form/website/torchlight/news_cn.json"
LAST_KNOWN_ID = "buYaN1rB"

try:
    print("æ­£åœ¨è·å–å…¬å‘Šæ•°æ®...")
    resp = requests.get(JSON_URL, timeout=10)
    resp.raise_for_status()
    data = resp.json()
    
    latest = data["zh-cn"]["announcement"][0]
    current_id = latest["link"].split("id=")[-1]
    title = latest["title"]
    link = latest["link"]
    
    print(f"æœ€æ–°å…¬å‘Š ID: {current_id}")
    print(f"æ ‡é¢˜: {title}")
    
    if current_id != LAST_KNOWN_ID and ("SS11" in title or "æ¸´ç˜¾ç—‡" in title):
        print("ğŸ‰ æ£€æµ‹åˆ° SS11 èµ›å­£å…¬å‘Šï¼")
        message = f"æ ‡é¢˜ï¼š{title}\n\né“¾æ¥ï¼š{link}"
        push_url = f"https://sctapi.ftqq.com/{os.getenv('SENDKEY')}.send"
        result = requests.post(push_url, data={"title": "ğŸ”¥ ç«ç‚¬ä¹‹å…‰ SS11 å…¬å‘Šå·²å‘å¸ƒï¼", "desp": message})
        print("æ¨é€çŠ¶æ€:", result.status_code)
    else:
        print("â„¹ï¸ æœªå‘ç°ç¬¦åˆæ¡ä»¶çš„æ–°å…¬å‘Šã€‚")
        
except Exception as e:
    print("âŒ é”™è¯¯:", str(e))
    sys.exit(1)
EOF
