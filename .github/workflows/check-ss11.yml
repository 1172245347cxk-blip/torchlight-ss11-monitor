name: Torchlight SS11 Monitor

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Install requests
        run: pip install requests

      - name: Check announcement
        env:
          SENDKEY: ${{ secrets.SENDKEY }}
        run: |
          python3 - <<'PYSCRIPT'
import requests
import os
import sys

JSON_URL = "https://website.xdcdn.net/form/website/torchlight/news_cn.json"
LAST_KNOWN_ID = "buYaN1rB"

try:
    data = requests.get(JSON_URL, timeout=10).json()
    latest = data["zh-cn"]["announcement"][0]
    current_id = latest["link"].split("id=")[-1]
    title = latest["title"]
    
    if current_id != LAST_KNOWN_ID and ("SS11" in title or "æ¸´ç˜¾ç—‡" in title):
        msg = f"æ ‡é¢˜ï¼š{title}\n\né“¾æŽ¥ï¼š{latest['link']}"
        url = f"https://sctapi.ftqq.com/{os.getenv('SENDKEY')}.send"
        requests.post(url, data={"title": "ðŸ”¥ SS11å…¬å‘Šå‘å¸ƒï¼", "desp": msg})
        print("Sent!")
    else:
        print("No update.")
except Exception as e:
    print("Error:", e)
    sys.exit(1)
PYSCRIPT
